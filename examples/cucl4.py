import numpy
from pyscf import gto, scf, lib
from pyscf.sfnoci.sfnoci import SFGNOCI
from sfnocisiso import sfnoci_siso
from sfnocisiso import utils
#from pySFNOCI.SFNOCI import SFNOCI
# model
model = '4o7ed2d' 
#model = '10o7ed2d' 
if 'd2d' in model:
    atom = """   Cu     -0.000031     -0.000016     -0.000234
  Cl      2.146470     -0.000040      0.870967
  Cl     -2.146442      0.000048      0.870932
  Cl     -0.000043      2.146466     -0.870845
  Cl      0.000046     -2.146458     -0.870819
  """
elif 'd4h' in model:
    atom = """  Cu      0.000008      0.000011      0.000000
  Cl      2.336259     -0.000012      0.000000
  Cl     -2.336248     -0.000017      0.000000
  Cl     -0.000007      2.336263      0.000000
  Cl     -0.000012     -2.336245      0.000000
  """
else:
    assert False 

n_threads = 1
hf_type = "RHF"  # RHF or UHF
mpg = 'c1'  # point group: d2h or c1
data_path = '../data/cucl4'

ano_cu = gto.basis.parse('''
Cu    S
9148883.                     0.00011722            -0.00003675             0.00001383            -0.00000271             0.00000346
1369956.                     0.00033155            -0.00010403             0.00003914            -0.00000766             0.00000979
 311782.6                    0.00088243            -0.00027733             0.00010439            -0.00002047             0.00002626
  88318.80                   0.00217229            -0.00068417             0.00025745            -0.00005030             0.00006392
  28815.53                   0.00529547            -0.00167686             0.00063203            -0.00012442             0.00016087
  10403.46                   0.01296630            -0.00413460             0.00155718            -0.00030269             0.00038023
   4057.791                  0.03188050            -0.01035127             0.00391659            -0.00077628             0.00101716
   1682.974                  0.07576569            -0.02534791             0.00959476            -0.00185240             0.00229152
    733.7543                 0.16244637            -0.05836947             0.02238837            -0.00448270             0.00597497
    333.2677                 0.28435959            -0.11673284             0.04528606            -0.00866024             0.01044695
    156.4338                 0.34173643            -0.18466860             0.07498378            -0.01544726             0.02151583
     74.69721                0.20955087            -0.14700899             0.06188170            -0.01089864             0.01030128
     33.32262                0.03544751             0.18483257            -0.09047327             0.01467867            -0.00984324
     16.62237               -0.00243996             0.56773609            -0.39288472             0.09154122            -0.14292630
      8.208260               0.00146990             0.37956092            -0.35664956             0.06330857            -0.05612707
      3.609400              -0.00064379             0.04703755             0.34554793            -0.06093879             0.09135650
      1.683449               0.00024738            -0.00072783             0.70639197            -0.27148545             0.45831402
      0.733757              -0.00008118             0.00102976             0.25335911            -0.10138944            -0.19726740
      0.110207               0.00001615            -0.00007020             0.00658749             0.71212180            -1.30310157
      0.038786              -0.00001233             0.00007090            -0.00044247             0.34613175             0.87975568
      0.015514               0.00000452            -0.00002454             0.00072338             0.07198709             0.57310889
Cu    P
   9713.253                  0.00039987            -0.00014879             0.00005053            -0.00015878
   2300.889                  0.00210157            -0.00078262             0.00026719            -0.00085359
    746.7706                 0.01001097            -0.00376229             0.00127718            -0.00399919
    284.6806                 0.03836039            -0.01457968             0.00499760            -0.01608092
    119.9999                 0.11626756            -0.04571093             0.01561376            -0.04924864
     54.07386                0.25899831            -0.10593013             0.03689701            -0.12165679
     25.37321                0.38428226            -0.16836228             0.05796469            -0.17713367
     12.20962                0.29911210            -0.10373213             0.03791966            -0.14448197
      5.757421               0.08000672             0.21083155            -0.11706499             0.64743311
      2.673402               0.00319440             0.48916443            -0.20912257             0.54797692
      1.186835               0.00147252             0.38468638            -0.05800532            -0.78180321
      0.481593              -0.00023391             0.08529338             0.16430736            -0.52607778
      0.192637               0.00020761            -0.00161045             0.52885466             0.22437177
      0.077055              -0.00008963             0.00206530             0.37373016             0.33392453
      0.030822               0.00002783            -0.00064175             0.08399866             0.14446374
Cu    D
    249.3497                 0.00134561            -0.00158359
     74.63837                0.01080983            -0.01281116
     28.37641                0.04733793            -0.05642679
     11.94893                0.13772582            -0.16641393
      5.317646               0.26263833            -0.35106014
      2.364417               0.33470401            -0.23717890
      1.012386               0.31000597             0.21994641
      0.406773               0.21316819             0.48841363
      0.147331               0.07865365             0.29537131
      0.058932               0.00603096             0.04295539
Cu    F
     15.4333                 0.03682063
      6.1172                 0.24591418
      2.4246                 0.50112688
      0.9610                 0.35850648
      0.3809                 0.14728062
      0.1510                 0.02564748
''')
ano_cl = gto.basis.parse('''
Cl    S
 399432.47                   0.00030484            -0.00008544             0.00002805            -0.00002594
  56908.833                  0.00097690            -0.00027415             0.00008993            -0.00008327
  16874.769                  0.00213829            -0.00060181             0.00019805            -0.00018239
   6010.0278                 0.00596941            -0.00168491             0.00055165            -0.00051268
   2303.2830                 0.01618189            -0.00461440             0.00152335            -0.00139557
    915.65994                0.04523017            -0.01312940             0.00430471            -0.00399682
    371.72009                0.11792451            -0.03590977             0.01193457            -0.01084095
    152.89109                0.26154412            -0.08838331             0.02937135            -0.02689456
     63.436303               0.40192154            -0.17459524             0.06021462            -0.05308441
     26.481723               0.26874482            -0.17768036             0.06257166            -0.05725505
     11.104112               0.03281694             0.15212083            -0.05661174             0.06432674
      4.6716289              0.00355918             0.62550754            -0.32750975             0.30253800
      1.9704520             -0.00170778             0.36355752            -0.34199199             0.51304681
       .83279460             0.00129735             0.00960204             0.31850883            -1.13091935
       .35254090            -0.00065905             0.02635221             0.66176117            -0.72817381
       .14943410             0.00024579             0.00476606             0.27830911             1.17413304
       .05977360            -0.00000146             0.00086954             0.01682723             0.32946196
Cl    P
   1288.9716                 0.00093570            -0.00024782             0.00024047
    312.24430                0.00612519            -0.00162654             0.00152795
    111.34634                0.02562804            -0.00687102             0.00673753
     43.736087               0.09281756            -0.02535755             0.02388784
     17.856524               0.24346160            -0.06874067             0.06877323
      7.4327659              0.41401588            -0.12202766             0.11190534
      3.1282538              0.34722988            -0.10596481             0.12059088
      1.3257214              0.07646871             0.13708383            -0.22523997
       .56441910             0.00212249             0.42571611            -0.64105309
       .24107410            -0.00079088             0.41428846             0.05174053
       .10320890            -0.00020296             0.18204070             0.69480634
       .04128360            -0.00009274             0.03011165             0.30411632
Cl    D
      3.6204561              0.02670164
      1.4775717              0.17231497
       .60302300             0.58274040
       .24610430             0.33745593
       .09844170             0.04917881
''')

mol = gto.M(atom=atom,
            symmetry=mpg,
            basis= {'Cu': ano_cu, 'Cl': ano_cl}, spin=1, charge=-2, verbose=5)


mf = scf.ROHF(mol)
mf.kernel()
mo = mf.mo_coeff
act = [7,8,9,34,35,36,37,50]



sfnoci = SFGNOCI(mf, 8, (8,7), groupA = [[0,1,2],[3,4,5,6,7]])
from pyscf.mcscf import addons
mo = addons.sort_mo(sfnoci, mo, act, 1)

sfnoci.mo_coeff = mo
mo_list, po_list, group = sfnoci.optimize_mo(mo)
dmet_core_list, ov_list = sfnoci.get_svd_matrices(mo_list, group)
dmet_act_list = sfnoci.get_active_dm(mo)
h1e, ecore_list = sfnoci.get_h1cas(dmet_act_list , mo_list , dmet_core_list)
eri = sfnoci.get_h2eff(mo)


ci_gr, ci_ex = utils.ci_gr_coreex_by_diag(sfnoci, 3, 5, (5,4), 5, 3, h1e ,eri,po_list,group, ov_list,ecore_list)
######compute hsoao#############
gsci = 0
for ici, ci in enumerate(ci_gr):
    if ci[4] < ci_gr[gsci][4]:
        gsci = ici

dmao = sfnoci.make_rdm1(ci_gr[gsci][5], mo, nelecas= (ci_gr[gsci][0],ci_gr[gsci][1]))
hsoao = sfnoci_siso.compute_hso_ao(mol, dmao, amfi = True) *2
################################
e_ex, hvec_ex = sfnoci_siso.kernel_siso_we(sfnoci, ci_ex, po_list, group, ov_list, hsoao = hsoao)

ms_dim_gr = [ci[2]+1 for ci in ci_gr]
idx_shift_gr = [sum(ms_dim_gr[:i]) for i in range(len(ms_dim_gr))]
e_gr = numpy.zeros(sum(ms_dim_gr))
for istate, ici in enumerate(ci_gr):
    for ii, i_ms2 in enumerate(range(-ici[2], ici[2] + 1, 2)):
        e_gr[idx_shift_gr[istate]+ii] = ici[4]
hvec_gr = numpy.identity(sum(ms_dim_gr))
dipole_sdm_coreex = sfnoci_siso.dipole_sdm_coreex_we(sfnoci,ci_ex,ci_gr,po_list, group, ov_list)

hvec_gr = hvec_gr[:,0]

trans_dipole = lib.einsum('lab, ai, b -> li', dipole_sdm_coreex, hvec_ex.conj(), hvec_gr)
f = lib.einsum('li, li -> i', trans_dipole.conj(), trans_dipole)
#breakpoint()


def f_broad(fi, ei, etha = 0.01):
    return lambda e : -(fi/(e-ei+1j*etha)).imag/numpy.pi
e_ex = e_ex - e_gr[0]
print(e_ex * 27.2114) 
e_p = []
for i, ei in enumerate(e_ex):
    e_p.append(f_broad(f[i], ei, etha = 0.01))
e_range = numpy.arange(e_ex[0]-2, e_ex[-1]+2, 0.01)
f_range = numpy.array(e_p[0](e_range))
for i in range(len(e_p)-1):
    f_range += numpy.array(e_p[i+1](e_range))

import matplotlib.pyplot as plt
fig, ax = plt.subplots()
ax.plot(e_range * 27.2114, f_range)
plt.show()
